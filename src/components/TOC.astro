---
interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
}

const { headings } = Astro.props;

// Filter to only h2 and h3
const tocHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3);
---

{tocHeadings.length > 0 && (
  <nav class="hidden lg:block" aria-label="Table of contents">
    <div class="sticky top-24">
      <h2 class="mb-4 text-sm font-semibold uppercase tracking-wide text-gray-900 dark:text-white">
        On this page
      </h2>
      <ul class="space-y-2 text-sm">
        {tocHeadings.map((heading) => (
          <li class:list={[heading.depth === 3 && 'ml-4']}>
            <a
              href={`#${heading.slug}`}
              class="toc-link block text-gray-600 transition-colors hover:text-accent dark:text-gray-400 dark:hover:text-accent-dark"
              data-heading={heading.slug}
            >
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </div>
  </nav>
)}

<script>
  function initTOC() {
    const tocLinks = document.querySelectorAll('.toc-link');
    const headings = document.querySelectorAll('h2[id], h3[id]');

    if (tocLinks.length === 0 || headings.length === 0) return;

    const observerOptions = {
      rootMargin: '-80px 0px -80% 0px',
      threshold: 0,
    };

    let currentActive: Element | null = null;

    const observer = new IntersectionObserver((entries) => {
      for (const entry of entries) {
        if (entry.isIntersecting) {
          const id = entry.target.getAttribute('id');
          const link = document.querySelector(`.toc-link[data-heading="${id}"]`);

          if (currentActive) {
            currentActive.classList.remove('text-accent', 'dark:text-accent-dark', 'font-medium');
            currentActive.classList.add('text-gray-600', 'dark:text-gray-400');
          }

          if (link) {
            link.classList.remove('text-gray-600', 'dark:text-gray-400');
            link.classList.add('text-accent', 'dark:text-accent-dark', 'font-medium');
            currentActive = link;
          }
        }
      }
    }, observerOptions);

    headings.forEach((heading) => observer.observe(heading));
  }

  initTOC();
  document.addEventListener('astro:after-swap', initTOC);
</script>

